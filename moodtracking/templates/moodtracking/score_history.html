

{% if mood_logs|length < 5 %}
<p style="color: var(--theme-color); text-align: center;">Not enough data to display a chart. Please log at least 5 mood records.</p>
{% else %}
<div style="max-width: 700px;">
    <canvas id="mood-chart" width="590" height="290"></canvas>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script> <!-- æ’ä»¶ç”¨äºæ˜¾ç¤ºæ ‡ç­¾ -->

<script>
// æå– Django æ¨¡æ¿ä¸­çš„ mood_logs æ•°æ®
const moodLogs = [
    {% for log in mood_logs %}
    {
        timestamp: "{{ log.timestamp|date:'Y-m-d H:i' }}",
        mood_score: {{ log.mood_score }}
    },
    {% endfor %}
];

if (moodLogs.length >= 5) {
    // æ•°æ®æŒ‰æ—¶é—´æ’åºåé€‰æ‹©æœ€è¿‘ 15 æ¡
    const filteredLogs = moodLogs.slice(0, 15);
    const scores = filteredLogs.map(log => log.mood_score);
    const timestamps = filteredLogs.map(log => log.timestamp);

    // å®šä¹‰å¿ƒæƒ…å›¾æ ‡å’Œæè¿°
    const moodIcons = {
        1: "â›ˆï¸", // æåº¦ä½è½
        2: "ğŸŒ§ï¸", // éå¸¸éš¾è¿‡
        3: "â˜ï¸", // éš¾è¿‡
        4: "ğŸŒ¥ï¸", // æœ‰ç‚¹éš¾è¿‡
        5: "â›…", // å¹³é™
        6: "ğŸŒ¤ï¸", // ç¨å¾®å¼€å¿ƒ
        7: "ğŸŒ", // å¼€å¿ƒ
        8: "â­", // éå¸¸å¼€å¿ƒ
        9: "ğŸŒŸ", // æ¿€åŠ¨
        10: "âœ¨" // æåº¦å¼€å¿ƒ
    };

    const moodDescriptions = {
        1: "Extremely Sad",
        2: "Very Sad",
        3: "Sad",
        4: "A Bit Sad",
        5: "Neutral",
        6: "Content",
        7: "Happy",
        8: "Very Happy",
        9: "Excited",
        10: "Extremely Happy"
    };

    // ç»˜åˆ¶æŠ˜çº¿å›¾
    const ctx = document.getElementById('mood-chart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: timestamps, // æ¨ªè½´ç”¨äºæ‚¬åœæ˜¾ç¤ºæ—¶é—´
            datasets: [{
                label: '', // ä¸æ˜¾ç¤ºå›¾ä¾‹
                data: scores,
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderWidth: 2,
                pointRadius: 0, // éšè—é»˜è®¤ç‚¹
                hoverRadius: 0, // ç¦ç”¨æ‚¬åœæ—¶ç‚¹çš„æ”¾å¤§
                tension: 0.4 // å¹³æ»‘æ›²çº¿
            }]
        },
        options: {
            responsive: true, // å“åº”å¼å¸ƒå±€
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false // å»æ‰å›¾ä¾‹
                },
                tooltip: {
                    enabled: true, // å¯ç”¨æ‚¬åœæç¤º
                    callbacks: {
                        title: function(context) {
                            // æ˜¾ç¤ºæ—¶é—´
                            return `Time: ${context[0].label}`;
                        },
                        label: function(context) {
                            const score = context.raw;
                            const description = moodDescriptions[score];
                            return `${description} (Mood Score: ${score})`;
                        }
                    }
                },
                datalabels: {
                    align: 'center', // å›¾æ ‡ä½ç½®åœ¨ç‚¹ä¸Š
                    anchor: 'center',
                    font: {
                        size: 16
                    },
                    formatter: function(value) {
                        return moodIcons[value]; // æ˜¾ç¤ºå¿ƒæƒ…å›¾æ ‡
                    }
                }
            },
            scales: {
                x: {
                    display: false // ä¸æ˜¾ç¤ºæ¨ªè½´å†…å®¹
                },
                y: {
                    title: {
                        display: true,
                        text: 'Mood Score'
                    },
                    beginAtZero: true,
                    suggestedMax: 10
                }
            }
        },
        plugins: [ChartDataLabels] // å¯ç”¨æ•°æ®æ ‡ç­¾æ’ä»¶
    });
}
</script>
